#!/bin/bash
#PBS -l nodes=1:ppn=16,walltime=4:00:00
#PBS -l vmem=31gb
#PBS -N tractseg
#PBS -V

# INPUT PARSING
dwi=$(jq -r '.dwi' config.json)
bvals=$(jq -r '.bvals' config.json)
bvecs=$(jq -r '.bvecs' config.json)
t1w=$(jq -r .t1 config.json)

#...

#create a subjects folder  (e.g., [root] will be subjects)
#create a subfolder of OUR subject (e.g., S1 will be just subject)
mkdir -p data/input


#copy files inside sybject folder in the way tractoflow wants
cp ${dwi} data/input/dwi.nii.gz
cp ${bvals} data/input/bval
cp ${bvecs} data/input/bvec
cp ${t1w} data/input/t1.nii.gz

    # --input=/path/to/[root]             Root folder containing multiple subjects

    #                                     [root]
    #                                     ├── S1
    #                                     │   ├── *dwi.nii.gz
    #                                     │   ├── *bval
    #                                     │   ├── *bvec
    #                                     │   ├── *rev_b0.nii.gz  (optional)
    #                                     │   ├── *aparc+aseg.nii.gz  (optional)
    #                                     │   ├── *wmparc.nii.gz  (optional)
    #                                     │   └── *t1.nii.gz
    #                                     └── S2
    #                                         ├── *dwi.nii.gz
    #                                         ├── *bval
    #                                         ├── *bvec
    #                                         ├── *rev_b0.nii.gz  (optional)
    #                                         ├── *aparc+aseg.nii.gz  (optional)
    #                                         ├── *wmparc.niZi.gz  (optional)
    #                                         └── *t1.nii.gz


#create subjects output folder
mkdir -p ./data/output
mkdir -p Resample_DWI
mkdir -p Resample_T1
mkdir -p PFT_Tracking

#run the singularity
# nextflow run ./main.nf  --input ./data/input/  -with-singularity scilus_1.6.0.sif  --output_dir ./data/output --processes 23

# Set desired Miniconda version and install directory
MINICONDA_VERSION="latest"
INSTALL_DIR="$HOME/miniconda3"
INSTALLER="Miniconda3-$MINICONDA_VERSION-Linux-x86_64.sh"
URL="https://repo.anaconda.com/miniconda/$INSTALLER"

# Download the installer
wget -O miniconda.sh "$URL"

# Run the installer silently
bash miniconda.sh -b -p "$INSTALL_DIR"

# Initialize conda for bash (or zsh, etc.)
"$INSTALL_DIR/bin/conda" init

# Activate conda
source "$HOME/.bashrc"  # or ~/.zshrc if you use zsh


# Create and activate conda environment without modifying .bashrc
conda create -n tractoflow -y
source $(conda info --base)/etc/profile.d/conda.sh
conda activate tractoflow
conda install nextflow=21.10.6 -c bioconda -y

# Clone Tractoflow repo (skip if already exists)
[ ! -d "tractoflow" ] && git clone https://github.com/scilus/tractoflow.git
cd tractoflow

# Make sure nextflow is in the path for this session only
export PATH="$(conda info --base)/envs/tractoflow/bin:$PATH"

# Run nextflow
nextflow run ./main.nf \
  --input ../data/input/ \
  -with-singularity ../scilus_1.6.0.sif \
  --output_dir ../data/output \
  --processes 23


#singularity exec  \
#  -B ./data/input:/data/input \
#  -B ./data/output:/data/output \
#  -e docker://sydneyfulton/tractoflow:0.0.1 \
#    tractoflow \
#    --input /data/input/ \
#    --output_dir /data/output/ \
#    -with-singularity /tractoflow/scilus_1.6.0.sif \
#    --processes 23



cp ./data/output/Resample_DWI/*__dwi_resampled.nii.gz ./Resample_DWI/dwi.nii.gz

cp ./data/output/Extract_FODF_Shell/*__bval_fodf ./Resample_DWI/dwi.bvals
cp ./data/output/Extract_FODF_Shell/*__bval_fodf ./Resample_DWI/dwi.bvals

cp ./data/output/Resample_T1/*__t1_resampled.nii.gz ./Resample_T1/t1.nii.gz
cp ./data/output/PFT_Tracking/*__pft_tracking_prob_wm_seed_0.trk ./PFT_Tracking/track.trk


#nextflow run /tractoflow/main.nf 
